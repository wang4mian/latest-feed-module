---
import DashboardLayout from '../layouts/DashboardLayout.astro';
---

<DashboardLayout title="å¡«Listå–ç¼–è¯‘ - KUATO">
  <!-- Page Header -->
  <div class="mb-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">å¡«Listå–ç¼–è¯‘ ğŸ“</h1>
        <p class="mt-1 text-sm text-gray-500">
          æç®€å·¥ä½œæµï¼šURLåˆ—è¡¨ â†’ ä¸€é”®ç¼–è¯‘ â†’ å¤åˆ¶å‘å¸ƒ
        </p>
      </div>
      <div class="flex items-center space-x-3">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800">
          ğŸš€ æ–°åŠŸèƒ½
        </span>
      </div>
    </div>
  </div>

  <!-- Main Compiler Interface -->
  <div class="max-w-4xl mx-auto">
    <!-- Input Section -->
    <div class="dashboard-card mb-6">
      <div class="dashboard-card-body">
        <h2 class="text-lg font-medium text-gray-900 mb-4">ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šè¾“å…¥URLåˆ—è¡¨</h2>
        <div class="space-y-4">
          <div>
            <label for="url-list" class="block text-sm font-medium text-gray-700 mb-2">
              ç²˜è´´ä»Šæ—¥å€¼å¾—ç¼–è¯‘çš„æ–‡ç« URLï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰
            </label>
            <textarea
              id="url-list"
              name="url-list"
              rows="8"
              class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-purple-500 focus:border-purple-500"
              placeholder="https://techcrunch.com/2025/01/15/ai-breakthrough-manufacturing/
https://venturebeat.com/2025/01/15/tesla-new-battery-tech/
https://spectrum.ieee.org/2025/01/15/robotics-advance/
https://www.reuters.com/technology/german-industry-40/

å¯ä»¥ç²˜è´´ä»»æ„æ•°é‡çš„URL..."
            ></textarea>
          </div>
          
          <!-- Quick Stats -->
          <div class="flex items-center justify-between text-sm text-gray-500">
            <span>æ£€æµ‹åˆ° <span id="url-count" class="font-medium text-purple-600">0</span> ä¸ªURL</span>
            <span>é¢„è®¡ç¼–è¯‘æ—¶é—´: <span id="estimate-time" class="font-medium text-purple-600">-</span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Section -->
    <div class="dashboard-card mb-6">
      <div class="dashboard-card-body">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-medium text-gray-900">ğŸš€ ç¬¬äºŒæ­¥ï¼šä¸€é”®ç¼–è¯‘</h3>
            <p class="text-sm text-gray-500 mt-1">ä½¿ç”¨Jina ReaderæŠ“å– + Gemini AIç¼–è¯‘</p>
          </div>
          <button 
            id="compile-btn"
            onclick="startCompilation()"
            class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            å¼€å§‹ç¼–è¯‘
          </button>
        </div>
      </div>
    </div>

    <!-- Progress Section (Initially Hidden) -->
    <div class="dashboard-card mb-6 hidden" id="progress-section">
      <div class="dashboard-card-body">
        <h3 class="text-lg font-medium text-gray-900 mb-4">âš¡ ç¼–è¯‘è¿›åº¦</h3>
        
        <!-- Progress Bar -->
        <div class="mb-4">
          <div class="flex justify-between text-sm font-medium text-gray-900 mb-1">
            <span>å¤„ç†è¿›åº¦</span>
            <span id="progress-text">0%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progress-bar" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>

        <!-- Status Messages -->
        <div id="status-messages" class="space-y-2">
          <!-- Dynamic status messages will be added here -->
        </div>
      </div>
    </div>

    <!-- Results Section (Initially Hidden) -->
    <div class="dashboard-card hidden" id="results-section">
      <div class="dashboard-card-body">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-medium text-gray-900">ğŸ“„ ç¬¬ä¸‰æ­¥ï¼šç¼–è¯‘ç»“æœ</h3>
          <div class="flex space-x-3">
            <button 
              onclick="copyResult()"
              id="copy-btn"
              class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
            >
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
              å¤åˆ¶ç»“æœ
            </button>
            <button 
              onclick="downloadResult()"
              class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500"
            >
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              ä¸‹è½½MD
            </button>
          </div>
        </div>
        
        <!-- Compiled Result -->
        <div class="bg-gray-50 rounded-lg p-4">
          <div id="compiled-result" class="prose prose-sm max-w-none">
            <!-- ç¼–è¯‘ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
          </div>
        </div>

        <!-- Raw Markdown (Hidden by default) -->
        <div class="mt-4">
          <button 
            onclick="toggleRawMarkdown()"
            class="text-sm text-purple-600 hover:text-purple-500"
          >
            æŸ¥çœ‹åŸå§‹Markdown â†“
          </button>
          <textarea 
            id="raw-markdown"
            class="hidden mt-2 w-full h-64 p-3 text-sm font-mono border border-gray-300 rounded-lg bg-white resize-none focus:outline-none focus:ring-2 focus:ring-purple-500"
            readonly
          ></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Help Section -->
  <div class="max-w-4xl mx-auto mt-8">
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-blue-800">ä½¿ç”¨æç¤º</h3>
          <div class="mt-2 text-sm text-blue-700">
            <ul class="list-disc list-inside space-y-1">
              <li>ğŸš€ ä½¿ç”¨Jina AI Reader LM-v2å¼•æ“ï¼Œæ™ºèƒ½æå–æ ¸å¿ƒå†…å®¹</li>
              <li>ğŸ¯ è‡ªåŠ¨å®šä½æ–‡ç« ä¸»ä½“ï¼Œè¿‡æ»¤å¹¿å‘Šã€å¯¼èˆªç­‰å™ªéŸ³å†…å®¹</li>
              <li>ğŸ“Š æä¾›å­—æ•°ç»Ÿè®¡ã€é˜…è¯»æ—¶é—´ã€å¯è¯»æ€§è¯„åˆ†ç­‰å…ƒæ•°æ®</li>
              <li>ğŸ”— è‡ªåŠ¨æå–ç›¸å…³é“¾æ¥æ‘˜è¦ï¼Œå¢å¼ºå†…å®¹å®Œæ•´æ€§</li>
              <li>ğŸ“ å»ºè®®æ¯æ¬¡è¾“å…¥3-8ä¸ªç›¸å…³URLï¼Œç¼–è¯‘æ•ˆæœæœ€ä½³</li>
              <li>ğŸ“± ç¼–è¯‘ç»“æœç›´æ¥é€‚é…å¾®ä¿¡å…¬ä¼—å·æ ¼å¼</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

</DashboardLayout>

<script>
  // URL counting and validation
  document.addEventListener('DOMContentLoaded', () => {
    const urlTextarea = document.getElementById('url-list');
    const urlCount = document.getElementById('url-count');
    const estimateTime = document.getElementById('estimate-time');
    const compileBtn = document.getElementById('compile-btn');

    urlTextarea.addEventListener('input', () => {
      const content = urlTextarea.value.trim();
      const urls = content ? content.split('\n').filter(line => {
        const trimmed = line.trim();
        return trimmed && (trimmed.startsWith('http://') || trimmed.startsWith('https://'));
      }) : [];
      
      urlCount.textContent = urls.length;
      
      if (urls.length > 0) {
        estimateTime.textContent = `çº¦${Math.ceil(urls.length * 15 / 60)}åˆ†é’Ÿ`;
        compileBtn.disabled = false;
        compileBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      } else {
        estimateTime.textContent = '-';
        compileBtn.disabled = true;
        compileBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }
    });
  });

  // Main compilation function
  async function startCompilation() {
    const urlTextarea = document.getElementById('url-list');
    const urls = urlTextarea.value.trim().split('\n').filter(line => {
      const trimmed = line.trim();
      return trimmed && (trimmed.startsWith('http://') || trimmed.startsWith('https://'));
    });

    if (urls.length === 0) {
      alert('è¯·å…ˆè¾“å…¥æœ‰æ•ˆçš„URLåˆ—è¡¨');
      return;
    }

    // Show progress section
    const progressSection = document.getElementById('progress-section');
    const resultsSection = document.getElementById('results-section');
    const compileBtn = document.getElementById('compile-btn');
    
    progressSection.classList.remove('hidden');
    resultsSection.classList.add('hidden');
    
    // Disable compile button
    compileBtn.disabled = true;
    compileBtn.innerHTML = `
      <svg class="w-5 h-5 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
      </svg>
      ç¼–è¯‘ä¸­...
    `;

    try {
      // Call compilation API
      await callCompilationAPI(urls);
    } catch (error) {
      console.error('Compilation failed:', error);
      addStatusMessage('âŒ ç¼–è¯‘å¤±è´¥: ' + error.message, 'error');
    } finally {
      // Re-enable compile button
      compileBtn.disabled = false;
      compileBtn.innerHTML = `
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
        </svg>
        é‡æ–°ç¼–è¯‘
      `;
    }
  }

  // Main compilation API call using Jina MCP
  async function callCompilationAPI(urls) {
    try {
      const totalSteps = 3; // MCP extraction + Gemini compilation + formatting
      let currentStep = 0;

      // Step 1: Enhanced Content Extraction
      addStatusMessage('ğŸ”— ä½¿ç”¨Jina AI Reader LM-v2å¼•æ“æå–å†…å®¹...', 'info');
      addStatusMessage(`ğŸ“¡ æ™ºèƒ½ç›®æ ‡å®šä½å’Œå™ªéŸ³æ¸…ç† - å¹¶è¡Œå¤„ç† ${urls.length} ä¸ªURL`, 'info');
      updateProgress(++currentStep, totalSteps);

      // Step 2: Gemini Compilation
      addStatusMessage('ğŸ¤– ä½¿ç”¨Gemini AIè¿›è¡Œæ·±åº¦ç¼–è¯‘...', 'info');
      updateProgress(++currentStep, totalSteps);

      // Call our MCP compilation API
      const response = await fetch('/api/compile-with-mcp', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          urls: urls,
          compilePrompt: null // Use default prompt
        })
      });

      if (!response.ok) {
        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
      }

      const result = await response.json();

      if (!result.success) {
        throw new Error(result.error || 'ç¼–è¯‘å¤±è´¥');
      }

      // Step 3: Format and display results
      addStatusMessage('âœ¨ æ ¼å¼åŒ–ç¼–è¯‘ç»“æœ...', 'info');
      updateProgress(++currentStep, totalSteps);

      // Show detailed extraction info
      addStatusMessage(`ğŸ“Š æˆåŠŸæå– ${result.extractedContents.length} ç¯‡æ–‡ç« `, 'success');
      addStatusMessage(`ğŸ“ ç¼–è¯‘æ¨¡å‹: ${result.compiledResult.model}`, 'info');
      addStatusMessage(`â° ç¼–è¯‘å®Œæˆæ—¶é—´: ${new Date(result.compiledResult.compiledAt).toLocaleString('zh-CN')}`, 'info');
      
      addStatusMessage('ğŸ‰ ç¼–è¯‘å®Œæˆï¼', 'success');

      // Display the compiled result
      showResults(result.compiledResult.content, result.extractedContents);

    } catch (error) {
      console.error('Compilation failed:', error);
      addStatusMessage(`âŒ ç¼–è¯‘å¤±è´¥: ${error.message}`, 'error');
      
      // Show fallback message
      addStatusMessage('ğŸ’¡ è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•', 'info');
      throw error;
    }
  }

  // Helper functions
  function updateProgress(current, total) {
    const percentage = Math.round((current / total) * 100);
    document.getElementById('progress-bar').style.width = percentage + '%';
    document.getElementById('progress-text').textContent = percentage + '%';
  }

  function addStatusMessage(message, type = 'info') {
    const statusMessages = document.getElementById('status-messages');
    const messageDiv = document.createElement('div');
    
    const colors = {
      info: 'text-blue-700 bg-blue-50',
      success: 'text-green-700 bg-green-50', 
      error: 'text-red-700 bg-red-50'
    };
    
    messageDiv.className = `text-sm px-3 py-2 rounded ${colors[type]}`;
    messageDiv.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
    
    statusMessages.appendChild(messageDiv);
    statusMessages.scrollTop = statusMessages.scrollHeight;
  }

  function showResults(compiledText, extractedContents = []) {
    const resultsSection = document.getElementById('results-section');
    const compiledResult = document.getElementById('compiled-result');
    const rawMarkdown = document.getElementById('raw-markdown');
    
    // Show results section
    resultsSection.classList.remove('hidden');
    
    // Convert markdown to HTML for better display
    const htmlContent = compiledText
      .replace(/^# (.*$)/gim, '<h1>$1</h1>')
      .replace(/^## (.*$)/gim, '<h2>$1</h2>')
      .replace(/^### (.*$)/gim, '<h3>$1</h3>')
      .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/gim, '<em>$1</em>')
      .replace(/\n\n/g, '</p><p>')
      .replace(/\n/g, '<br>')
      .replace(/^(.*)/, '<p>$1')
      .concat('</p>');
    
    // Set content
    compiledResult.innerHTML = htmlContent;
    rawMarkdown.value = compiledText;
    
    // Add source information if available
    if (extractedContents && extractedContents.length > 0) {
      const sourceInfo = document.createElement('div');
      sourceInfo.className = 'mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200';
      sourceInfo.innerHTML = `
        <h4 class="text-sm font-medium text-blue-800 mb-2">ğŸ“‹ æºæ–‡ç« ä¿¡æ¯</h4>
        <div class="space-y-1 text-xs text-blue-700">
          ${extractedContents.map((item, index) => `
            <div class="flex items-start space-x-2">
              <span class="font-medium">${index + 1}.</span>
              <div>
                <div class="font-medium">${item.title}</div>
                <div class="text-blue-600">${item.url}</div>
                <div class="text-gray-500 space-x-2">
                  <span>æå–äº: ${new Date(item.extractedAt).toLocaleString('zh-CN')}</span>
                  ${item.word_count ? `<span>â€¢ ${item.word_count}å­—</span>` : ''}
                  ${item.reading_time ? `<span>â€¢ ${item.reading_time}</span>` : ''}
                  ${item.engine ? `<span>â€¢ ${item.engine}</span>` : ''}
                </div>
                ${item.readability_score ? `<div class="text-xs text-green-600">å¯è¯»æ€§: ${item.readability_score}</div>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `;
      compiledResult.appendChild(sourceInfo);
    }
    
    // Scroll to results
    resultsSection.scrollIntoView({ behavior: 'smooth' });
  }

  // Result actions
  function copyResult() {
    const rawMarkdown = document.getElementById('raw-markdown');
    const copyBtn = document.getElementById('copy-btn');
    
    navigator.clipboard.writeText(rawMarkdown.value).then(() => {
      const originalText = copyBtn.innerHTML;
      copyBtn.innerHTML = `
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        å·²å¤åˆ¶
      `;
      copyBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
      copyBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
      
      setTimeout(() => {
        copyBtn.innerHTML = originalText;
        copyBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
        copyBtn.classList.add('bg-green-600', 'hover:bg-green-700');
      }, 2000);
    }).catch(() => {
      alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
    });
  }

  function downloadResult() {
    const rawMarkdown = document.getElementById('raw-markdown');
    const blob = new Blob([rawMarkdown.value], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ç¼–è¯‘ç»“æœ-${new Date().toISOString().split('T')[0]}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function toggleRawMarkdown() {
    const rawMarkdown = document.getElementById('raw-markdown');
    const button = rawMarkdown.previousElementSibling;
    
    if (rawMarkdown.classList.contains('hidden')) {
      rawMarkdown.classList.remove('hidden');
      button.textContent = 'éšè—åŸå§‹Markdown â†‘';
    } else {
      rawMarkdown.classList.add('hidden');
      button.textContent = 'æŸ¥çœ‹åŸå§‹Markdown â†“';
    }
  }

  // Expose functions to global scope
  window.startCompilation = startCompilation;
  window.copyResult = copyResult;
  window.downloadResult = downloadResult;
  window.toggleRawMarkdown = toggleRawMarkdown;
</script>

<style>
  .prose {
    color: #374151;
    max-width: none;
  }
  
  .prose h1 {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: #1f2937;
  }
  
  .prose h2 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    color: #1f2937;
  }
  
  .prose p {
    margin-bottom: 1rem;
    line-height: 1.6;
  }
  
  .prose ul {
    margin-left: 1.5rem;
    margin-bottom: 1rem;
  }
  
  .prose li {
    margin-bottom: 0.5rem;
  }
</style>