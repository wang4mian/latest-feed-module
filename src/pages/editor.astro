---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import { getArticles } from '../lib/supabase';

// ä¸´æ—¶ï¼šè·å–æ‰€æœ‰æ–‡ç« æ¥è°ƒè¯•
const { data: allArticles, error: allError } = await getArticles({
  limit: 50,
  sort: 'ai_score_desc'
});

// è·å–ç”¨æˆ·å·²é‡‡ç”¨çš„æ–‡ç« ï¼ˆé€šè¿‡æ–‡ç« æ± ç‚¹å‡»"é‡‡ç”¨"æŒ‰é’®çš„æ–‡ç« ï¼‰
const { data: adoptedArticles, error } = await getArticles({
  status: 'adopted',
  limit: 50,
  sort: 'ai_score_desc'
});

// è°ƒè¯•ä¿¡æ¯
console.log('ç¼–è¾‘å° - æ‰€æœ‰æ–‡ç« :', {
  count: allArticles?.length || 0,
  error: allError,
  statuses: allArticles?.map(a => a.overall_status) || []
});

console.log('ç¼–è¾‘å° - å·²é€šè¿‡æ–‡ç« æŸ¥è¯¢ç»“æœ:', {
  count: adoptedArticles?.length || 0,
  error: error,
  articles: adoptedArticles
});

// æ ¼å¼åŒ–æ—¥æœŸ
const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString('zh-CN', {
    month: 'short', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
};

// è·å–åˆ†ç±»æ˜¾ç¤ºæ–‡æœ¬
const getCategoryText = (category: string) => {
  const categoryMap: { [key: string]: string } = {
    'Core Equipment': 'æ ¸å¿ƒè®¾å¤‡',
    'Supply Chain': 'ä¾›åº”é“¾', 
    'Market Trends': 'å¸‚åœºè¶‹åŠ¿',
    'Technological Innovation': 'æŠ€æœ¯åˆ›æ–°',
    'Business Models': 'å•†ä¸šæ¨¡å¼'
  };
  return categoryMap[category] || category || 'æœªåˆ†ç±»';
};

// è·å–è¯„åˆ†é¢œè‰²ç±» (ç°åœ¨ä½¿ç”¨ Tailwind)
const getScoreColor = (score: number) => {
  if (score >= 80) return 'text-green-600';
  if (score >= 60) return 'text-yellow-600';
  return 'text-gray-500';
};
---

<DashboardLayout title="ç¼–è¾‘å° - KUATO">
  <!-- Page Header -->
  <div class="mb-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">ç¼–è¾‘å·¥ä½œå°</h1>
        <p class="mt-1 text-sm text-gray-500">
          KUATO AIæ™ºèƒ½å†…å®¹åˆ›ä½œå¹³å° - åŸºäºAIç­›é€‰æ–‡ç« åˆ›ä½œæ·±åº¦æƒ…æŠ¥å†…å®¹
        </p>
      </div>
      <div class="flex items-center space-x-3">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
          {adoptedArticles?.length || 0} ç¯‡å·²é€šè¿‡
        </span>
      </div>
    </div>
  </div>

  <!-- Two Column Layout -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-12rem)]">
    
    <!-- Left Column: Article List -->
    <div class="lg:col-span-1 bg-gray-50 rounded-lg border border-gray-200 flex flex-col">
      <div class="p-4 border-b border-gray-200">
        <!-- Header -->
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-medium text-gray-900">å·²é€šè¿‡æ–‡ç« </h3>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
            {adoptedArticles?.length || 0}
          </span>
        </div>
        
        <!-- Search Box -->
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          <input 
            type="search" 
            placeholder="æœç´¢æ–‡ç« æ ‡é¢˜..."
            class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm"
          />
        </div>
      </div>
      
      <!-- Article List -->
      <div class="flex-1 overflow-y-auto p-4 space-y-3">
        {adoptedArticles && adoptedArticles.length > 0 ? (
          adoptedArticles.map((article: any) => (
            <div class="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow cursor-pointer" 
                 data-article-id={article.id}>
              <!-- Score and Date -->
              <div class="flex items-center justify-between mb-2">
                <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold ${
                  (article.ai_score || 0) >= 80 ? 'bg-green-100 text-green-800' : 
                  (article.ai_score || 0) >= 60 ? 'bg-yellow-100 text-yellow-800' : 
                  'bg-gray-100 text-gray-800'
                }`}>
                  {article.ai_score || 0}
                </span>
                <span class="text-xs text-gray-500">
                  {formatDate(article.created_at)}
                </span>
              </div>
              
              <!-- Title -->
              <h4 class="text-sm font-medium text-gray-900 line-clamp-2 mb-2">
                {article.title}
              </h4>
              
              <!-- Meta Info -->
              <div class="flex items-center text-xs text-gray-500 mb-3 space-x-2">
                <span>{article.rss_sources?.name || 'æœªçŸ¥æ¥æº'}</span>
                {article.ai_category && (
                  <>
                    <span>â€¢</span>
                    <span>{getCategoryText(article.ai_category)}</span>
                  </>
                )}
              </div>
              
              <!-- Actions -->
              <div class="flex space-x-2">
                <button class="inline-flex items-center px-3 py-1 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 use-article" 
                        data-id={article.id}>
                  <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                  </svg>
                  ä½¿ç”¨æ–‡ç« 
                </button>
                <button class="inline-flex items-center px-3 py-1 text-xs font-medium text-gray-700 bg-gray-100 rounded hover:bg-gray-200 view-original" 
                        data-url={article.link}>
                  <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                  </svg>
                  æŸ¥çœ‹åŸæ–‡
                </button>
              </div>
            </div>
          ))
        ) : (
          <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p class="mt-4 text-sm text-gray-500">æš‚æ— å·²é€šè¿‡çš„æ–‡ç« </p>
            <p class="text-xs text-gray-400">è¯·å…ˆåˆ°æ–‡ç« æ± ç­›é€‰é€šè¿‡ä¸€äº›æ–‡ç« </p>
          </div>
        )}
      </div>
    </div>

    <!-- Right Column: Doocs MD Editor -->
    <div class="lg:col-span-2 bg-white rounded-lg border border-gray-200 flex flex-col">
      
      <!-- Editor Header -->
      <div class="p-4 border-b border-gray-200">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center text-gray-700">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            <span class="font-medium">Doocs MD ç¼–è¾‘å™¨</span>
          </div>
          <div class="flex items-center space-x-2">
            <button class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" id="refresh-editor">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              åˆ·æ–°ç¼–è¾‘å™¨
            </button>
            <a class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" href="https://md.doocs.org/" target="_blank">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
              æ–°çª—å£æ‰“å¼€
            </a>
          </div>
        </div>
        
        <!-- Template Selector -->
        <div class="space-y-3">
          <div class="flex items-center space-x-3">
            <label class="text-sm font-medium text-gray-700">é€‰æ‹©æ¨¡æ¿:</label>
            <select id="template-selector" class="text-sm border border-gray-300 rounded-md px-3 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="intelligence" selected>ğŸ§  åˆ¶é€ ä¸šæƒ…æŠ¥åˆ†æ (æ¨è)</option>
              <optgroup label="ğŸ“± å¾®ä¿¡å…¬ä¼—å·æ¨¡æ¿">
                <option value="wechat-template1">æ¨¡æ¿1 (KUATOåˆ¶é€ ä¸šæƒ…æŠ¥)</option>
                <!-- <option value="wechat-template2">æ¨¡æ¿2 (å¾…é…ç½®)</option> -->
                <!-- <option value="wechat-template3">æ¨¡æ¿3 (å¾…é…ç½®)</option> -->
              </optgroup>
              <optgroup label="ğŸ“‹ åˆ†ææŠ¥å‘Šæ¨¡æ¿">
                <option value="benchmark">ğŸ¯ ä¸­å¤–å¯¹æ ‡åˆ†æ</option>
                <option value="technology">ğŸ”¬ æŠ€æœ¯åˆ›æ–°è·Ÿè¸ª</option>
                <option value="market">ğŸ“ˆ å¸‚åœºåŠ¨æ€åˆ†æ</option>
                <option value="basic">ğŸ“„ åŸºç¡€ä¿¡æ¯æ•´ç†</option>
              </optgroup>
            </select>
            <button id="preview-template" class="text-xs px-2 py-1 bg-blue-50 text-blue-600 rounded border border-blue-200 hover:bg-blue-100">
              é¢„è§ˆæ¨¡æ¿
            </button>
            <span class="text-xs text-gray-500">é€‰æ‹©æ¨¡æ¿åç‚¹å‡»"ä½¿ç”¨æ–‡ç« "ç”Ÿæˆå†…å®¹</span>
          </div>
          
          
          <!-- Template Info -->
          <div id="template-info" class="text-xs text-gray-600 bg-blue-50 p-2 rounded" style="display: none;">
            <span id="template-info-content"></span>
          </div>
        </div>
      </div>
      
      <!-- Doocs MD iframe Editor -->
      <div class="flex-1 relative">
        <iframe 
          id="doocs-editor"
          src="https://md.doocs.org/"
          class="w-full h-full"
          style="border: none; background: white;"
          sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"
        ></iframe>
      </div>
      
      <!-- Editor Footer -->
      <div class="p-3 bg-gray-50 border-t border-gray-200 text-sm">
        <div class="flex items-center justify-between">
          <div class="flex items-center text-gray-600">
            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
            <span>Doocs MD å¼€æºç¼–è¾‘å™¨ - æ”¯æŒå®æ—¶é¢„è§ˆã€ä¸»é¢˜åˆ‡æ¢ã€æ•°å­¦å…¬å¼ã€å¾®ä¿¡å…¬ä¼—å·æ ·å¼</span>
          </div>
          <div id="editor-status" class="flex items-center text-gray-500">
            <svg class="w-4 h-4 mr-1 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            ç¼–è¾‘å™¨åŠ è½½ä¸­...
          </div>
        </div>
      </div>
      
    </div>
    
  </div>

</DashboardLayout>

<script>
  // è·å–å½“å‰é€‰æ‹©çš„æ¨¡æ¿
  function getSelectedTemplate(): string {
    const selector = document.getElementById('template-selector') as HTMLSelectElement;
    return selector ? selector.value : 'basic';
  }

  // åˆ¶é€ ä¸šæƒ…æŠ¥åˆ†ææ¨¡æ¿ - ä¸“ä¸šæŠ¥å‘Šæ ¼å¼
  function generateIntelligenceTemplate(article: any): string {
    const date = new Date(article.created_at).toLocaleDateString('zh-CN');
    const reportDate = new Date().toLocaleDateString('zh-CN');
    
    return `# **æ™ºèƒ½åˆ¶é€ è¡Œä¸šç ”ç©¶**

## **${article.title}**

---

**å‘å¸ƒæœºæ„**: KUATOåˆ¶é€ ä¸šæƒ…æŠ¥ç³»ç»Ÿ  
**æŠ¥å‘Šæ—¥æœŸ**: ${reportDate}  
**ä¿¡æ¯æ¥æº**: ${article.rss_sources?.name || 'æœªçŸ¥'}  
**AIè¯„åˆ†**: ${article.ai_score || 'N/A'}/100  

---

### **ä¸€ã€äº‹ä»¶æ¦‚è¿°**

${article.ai_summary || '[ è¯·è¡¥å……äº‹ä»¶æ¦‚è¿° ]'}

### **äºŒã€æ ¸å¿ƒè§‚ç‚¹è§£è¯»**

**2.1 æŠ€æœ¯äº®ç‚¹**
- æ ¸å¿ƒåˆ›æ–°: [ å¾…åˆ†æ ]
- æŠ€æœ¯çªç ´: [ å¾…åˆ†æ ]
- åº”ç”¨ä»·å€¼: [ å¾…åˆ†æ ]

**2.2 å¸‚åœºå½±å“**
- å¸‚åœºè§„æ¨¡: [ å¾…åˆ†æ ]
- ç«äº‰æ ¼å±€: [ å¾…åˆ†æ ]
- å‘å±•è¶‹åŠ¿: [ å¾…åˆ†æ ]

### **ä¸‰ã€æ·±åº¦åˆ†æ**

**3.1 å›½å¤–æ¡ˆä¾‹ç ”ç©¶**

${article.full_content || article.description || '[ è¯·è¡¥å……å›½å¤–æ¡ˆä¾‹è¯¦æƒ… ]'}

**3.2 ä¸­å›½å¯¹æ ‡ä¼ä¸š**

| ä¼ä¸šåç§° | æŠ€æœ¯æ°´å¹³ | å¸‚åœºåœ°ä½ | ç«äº‰ä¼˜åŠ¿ |
|----------|----------|----------|----------|
| [ ä¼ä¸šA ] | [ è¯„ä¼° ] | [ åœ°ä½ ] | [ ä¼˜åŠ¿ ] |
| [ ä¼ä¸šB ] | [ è¯„ä¼° ] | [ åœ°ä½ ] | [ ä¼˜åŠ¿ ] |
| [ ä¼ä¸šC ] | [ è¯„ä¼° ] | [ åœ°ä½ ] | [ ä¼˜åŠ¿ ] |

### **å››ã€æˆ˜ç•¥æ„ä¹‰è¯„ä¼°**

${article.ai_strategic_implication || '[ è¯·è¡¥å……æˆ˜ç•¥æ„ä¹‰åˆ†æ ]'}

**æŠ•èµ„ä»·å€¼è¯„ä¼°**:
- **æŠ€æœ¯åˆ›æ–°**: â­â­â­â­â­
- **å¸‚åœºå‰æ™¯**: â­â­â­â­â­  
- **æ”¿ç­–æ”¯æŒ**: â­â­â­â­â­
- **é£é™©æ§åˆ¶**: â­â­â­â­â­

### **äº”ã€è¡Œä¸šæ´å¯Ÿä¸å»ºè®®**

**5.1 è¡Œä¸šå‘å±•è¶‹åŠ¿**
1. [ è¶‹åŠ¿ä¸€ ]
2. [ è¶‹åŠ¿äºŒ ]
3. [ è¶‹åŠ¿ä¸‰ ]

**5.2 æŠ•èµ„æœºä¼šåˆ†æ**
- **çŸ­æœŸæœºä¼š** (6ä¸ªæœˆå†…): [ å…·ä½“æœºä¼š ]
- **ä¸­æœŸå¸ƒå±€** (1-2å¹´): [ å…·ä½“æ–¹å‘ ]
- **é•¿æœŸæˆ˜ç•¥** (3-5å¹´): [ æˆ˜ç•¥é‡ç‚¹ ]

**5.3 é£é™©æç¤º**
- æŠ€æœ¯é£é™©: [ é£é™©åˆ†æ ]
- å¸‚åœºé£é™©: [ é£é™©åˆ†æ ]
- æ”¿ç­–é£é™©: [ é£é™©åˆ†æ ]

---

### **å…­ã€ç»“è®ºä¸å»ºè®®**

**æ ¸å¿ƒç»“è®º**: [ è¯·åŸºäºä»¥ä¸Šåˆ†æå¾—å‡ºæ ¸å¿ƒç»“è®º ]

**è¡ŒåŠ¨å»ºè®®**:
1. **ç«‹å³è¡ŒåŠ¨**: [ å…·ä½“å»ºè®® ]
2. **å¯†åˆ‡å…³æ³¨**: [ å…³æ³¨é‡ç‚¹ ]
3. **é•¿æœŸå¸ƒå±€**: [ å¸ƒå±€æ–¹å‘ ]

---

**æŠ¥å‘Šå£°æ˜**: æœ¬æŠ¥å‘ŠåŸºäºå…¬å¼€ä¿¡æ¯å’ŒAIæ™ºèƒ½åˆ†æï¼Œä»…ä¾›å‚è€ƒã€‚æŠ•èµ„å†³ç­–è¯·ç»“åˆå…·ä½“æƒ…å†µè°¨æ…è€ƒè™‘ã€‚

**æ•°æ®æ¥æº**: ${article.link}  
**åˆ†æå¸ˆ**: KUATO AIæ™ºèƒ½åˆ†æç³»ç»Ÿ  
**æŠ¥å‘Šç¼–å·**: ${article.id?.substring(0, 8) || 'N/A'}`;
  }

  // æŠ€æœ¯åˆ›æ–°è·Ÿè¸ªæ¨¡æ¿
  function generateTechnologyTemplate(article: any): string {
    const date = new Date(article.created_at).toLocaleDateString('zh-CN');
    
    return `# ğŸ”¬ æŠ€æœ¯åˆ›æ–°è·Ÿè¸ªæŠ¥å‘Š

## ${article.title}

---

### ğŸ†• æŠ€æœ¯äº®ç‚¹

${article.ai_summary || ''}

### ğŸ­ æŠ€æœ¯åˆ†ç±»
- **é¢†åŸŸ**: ${article.ai_category || 'å¾…åˆ†ç±»'}
- **åˆ›æ–°åº¦**: ${article.ai_score || 'N/A'}/100
- **æˆç†Ÿåº¦**: [ å®éªŒå®¤é˜¶æ®µ / äº§å“åŒ– / è§„æ¨¡åº”ç”¨ ]

### ğŸ”§ æŠ€æœ¯è¯¦è§£

${article.full_content || article.description || ''}

### ğŸ“Š æŠ€æœ¯è¯„ä¼°

| ç»´åº¦ | è¯„çº§ | è¯´æ˜ |
|------|------|------|
| **æŠ€æœ¯çªç ´æ€§** | â­â­â­â­â­ | [ è¯„ä¼°è¯´æ˜ ] |
| **å•†ä¸šåŒ–æ½œåŠ›** | â­â­â­â­â­ | [ è¯„ä¼°è¯´æ˜ ] |
| **ç«äº‰ä¼˜åŠ¿** | â­â­â­â­â­ | [ è¯„ä¼°è¯´æ˜ ] |
| **æŠ•èµ„ä»·å€¼** | â­â­â­â­â­ | [ è¯„ä¼°è¯´æ˜ ] |

### ğŸ¯ åº”ç”¨å‰æ™¯

**æ½œåœ¨åº”ç”¨åœºæ™¯**ï¼š
- [ åœºæ™¯1 ]
- [ åœºæ™¯2 ]
- [ åœºæ™¯3 ]

**å¸‚åœºé¢„æœŸ**ï¼š
${article.ai_strategic_implication || '[ å¾…åˆ†æ ]'}

### ğŸ”— ç›¸å…³æŠ€æœ¯

- [ ç›¸å…³æŠ€æœ¯1 ]
- [ ç›¸å…³æŠ€æœ¯2 ]  
- [ ç›¸å…³æŠ€æœ¯3 ]

---

**æ•°æ®æ¥æº**: ${article.rss_sources?.name || 'æœªçŸ¥'} | ${date}`;
  }

  // å¸‚åœºåŠ¨æ€åˆ†ææ¨¡æ¿
  function generateMarketTemplate(article: any): string {
    const date = new Date(article.created_at).toLocaleDateString('zh-CN');
    
    return `# ğŸ“ˆ å¸‚åœºåŠ¨æ€åˆ†æ

## ${article.title}

---

### ğŸ“Š å¸‚åœºæ¦‚å†µ

${article.ai_summary || ''}

### ğŸ’° å¸‚åœºæ•°æ®

| æŒ‡æ ‡ | æ•°å€¼ | å¤‡æ³¨ |
|------|------|------|
| **å¸‚åœºè§„æ¨¡** | [ å¾…å¡«å…¥ ] | [ è¯´æ˜ ] |
| **å¢é•¿ç‡** | [ å¾…å¡«å…¥ ] | [ è¯´æ˜ ] |
| **ä¸»è¦ç©å®¶** | [ å¾…å¡«å…¥ ] | [ è¯´æ˜ ] |

### ğŸŒŠ å¸‚åœºè¶‹åŠ¿

${article.ai_strategic_implication || ''}

### ğŸ¢ å…³é”®ä¼ä¸šåŠ¨æ€

${article.full_content || article.description || ''}

### ğŸ“‹ SWOTåˆ†æ

| ä¼˜åŠ¿ (Strengths) | åŠ£åŠ¿ (Weaknesses) |
|------------------|-------------------|
| â€¢ [ ä¼˜åŠ¿1 ] | â€¢ [ åŠ£åŠ¿1 ] |
| â€¢ [ ä¼˜åŠ¿2 ] | â€¢ [ åŠ£åŠ¿2 ] |

| æœºä¼š (Opportunities) | å¨èƒ (Threats) |
|---------------------|----------------|
| â€¢ [ æœºä¼š1 ] | â€¢ [ å¨èƒ1 ] |
| â€¢ [ æœºä¼š2 ] | â€¢ [ å¨èƒ2 ] |

### ğŸ¯ æŠ•èµ„å»ºè®®

**çŸ­æœŸ** (1-6ä¸ªæœˆ):
- [ å»ºè®®1 ]

**ä¸­æœŸ** (6-18ä¸ªæœˆ):  
- [ å»ºè®®2 ]

**é•¿æœŸ** (2-5å¹´):
- [ å»ºè®®3 ]

---

**åˆ†æå¸ˆ**: KUATO AI | **æŠ¥å‘Šæ—¥æœŸ**: ${date}`;
  }

  // ä¸­å¤–å¯¹æ ‡åˆ†ææ¨¡æ¿ - ä¸“ä¸šå¯¹æ ‡æŠ¥å‘Šæ ¼å¼
  function generateBenchmarkTemplate(article: any): string {
    const date = new Date(article.created_at).toLocaleDateString('zh-CN');
    const reportDate = new Date().toLocaleDateString('zh-CN');
    
    return `# **ä¸­å¤–åˆ¶é€ ä¸šå¯¹æ ‡ç ”ç©¶æŠ¥å‘Š**

## **${article.title}**

---

**å‘å¸ƒæœºæ„**: KUATOåˆ¶é€ ä¸šæƒ…æŠ¥ç³»ç»Ÿ  
**æŠ¥å‘Šæ—¥æœŸ**: ${reportDate}  
**å¯¹æ ‡é¢†åŸŸ**: ${article.ai_category || 'ç»¼åˆåˆ¶é€ '}  
**åˆ†æè¯„åˆ†**: ${article.ai_score || 'N/A'}/100  

---

### **æ‰§è¡Œæ‘˜è¦**

${article.ai_summary || '[ è¯·è¡¥å……æ‰§è¡Œæ‘˜è¦ ]'}

---

### **ä¸€ã€å›½å¤–æ ‡æ†æ¡ˆä¾‹**

**1.1 æ¡ˆä¾‹æ¦‚è¿°**

${article.full_content || article.description || '[ è¯·è¡¥å……å›½å¤–æ¡ˆä¾‹è¯¦æƒ… ]'}

**1.2 æ ¸å¿ƒç«äº‰åŠ›åˆ†æ**
- **æŠ€æœ¯ä¼˜åŠ¿**: [ åˆ†ææŠ€æœ¯é¢†å…ˆæ€§ ]
- **å¸‚åœºåœ°ä½**: [ åˆ†æå¸‚åœºå æœ‰ç‡å’Œå½±å“åŠ› ]  
- **å•†ä¸šæ¨¡å¼**: [ åˆ†æç›ˆåˆ©æ¨¡å¼å’Œä»·å€¼é“¾ ]
- **åˆ›æ–°èƒ½åŠ›**: [ åˆ†æç ”å‘æŠ•å…¥å’Œåˆ›æ–°æœºåˆ¶ ]

### **äºŒã€ä¸­å›½ä¼ä¸šå¯¹æ ‡åˆ†æ**

**2.1 å¯¹æ ‡ä¼ä¸šæ¦‚è§ˆ**

| ä¸­å›½ä¼ä¸š | ä¸šåŠ¡é¢†åŸŸ | å¸‚åœºåœ°ä½ | æŠ€æœ¯æ°´å¹³ | å‘å±•é˜¶æ®µ |
|----------|----------|----------|----------|----------|
| [ ä¼ä¸šA ] | [ é¢†åŸŸ ] | [ åœ°ä½ ] | [ æ°´å¹³ ] | [ é˜¶æ®µ ] |
| [ ä¼ä¸šB ] | [ é¢†åŸŸ ] | [ åœ°ä½ ] | [ æ°´å¹³ ] | [ é˜¶æ®µ ] |
| [ ä¼ä¸šC ] | [ é¢†åŸŸ ] | [ åœ°ä½ ] | [ æ°´å¹³ ] | [ é˜¶æ®µ ] |

**2.2 æ ¸å¿ƒå·®è·åˆ†æ**

| å¯¹æ¯”ç»´åº¦ | å›½å¤–æ ‡æ† | ä¸­å›½ä¼ä¸š | å·®è·ç¨‹åº¦ | è¿½èµ¶éš¾åº¦ |
|----------|----------|----------|----------|----------|
| **æŠ€æœ¯ç ”å‘** | [ è¯„ä¼° ] | [ è¯„ä¼° ] | [ å·®è· ] | [ éš¾åº¦ ] |
| **å¸‚åœºè§„æ¨¡** | [ è¯„ä¼° ] | [ è¯„ä¼° ] | [ å·®è· ] | [ éš¾åº¦ ] |
| **èµ„æœ¬å®åŠ›** | [ è¯„ä¼° ] | [ è¯„ä¼° ] | [ å·®è· ] | [ éš¾åº¦ ] |
| **äººæ‰å‚¨å¤‡** | [ è¯„ä¼° ] | [ è¯„ä¼° ] | [ å·®è· ] | [ éš¾åº¦ ] |
| **äº§ä¸šç”Ÿæ€** | [ è¯„ä¼° ] | [ è¯„ä¼° ] | [ å·®è· ] | [ éš¾åº¦ ] |

### **ä¸‰ã€ç«äº‰æ€åŠ¿ä¸è¶‹åŠ¿**

**3.1 å…¨çƒç«äº‰æ ¼å±€**

${article.ai_strategic_implication || '[ è¯·è¡¥å……ç«äº‰æ€åŠ¿åˆ†æ ]'}

**3.2 å‘å±•è¶‹åŠ¿é¢„åˆ¤**
1. **æŠ€æœ¯å‘å±•è¶‹åŠ¿**: [ è¶‹åŠ¿åˆ†æ ]
2. **å¸‚åœºæ¼”å˜è¶‹åŠ¿**: [ è¶‹åŠ¿åˆ†æ ]
3. **æ”¿ç­–ç¯å¢ƒè¶‹åŠ¿**: [ è¶‹åŠ¿åˆ†æ ]

### **å››ã€æ”¿ç­–ç¯å¢ƒå¯¹æ¯”**

**4.1 å›½å¤–æ”¿ç­–æ”¯æŒ**
- ç ”å‘æ‰¶æŒ: [ æ”¿ç­–å†…å®¹ ]
- äº§ä¸šå¼•å¯¼: [ æ”¿ç­–å†…å®¹ ]
- å¸‚åœºä¿æŠ¤: [ æ”¿ç­–å†…å®¹ ]

**4.2 ä¸­å›½æ”¿ç­–æœºé‡**
- å›½å®¶æˆ˜ç•¥: [ æ”¿ç­–æœºé‡ ]
- äº§ä¸šæ”¿ç­–: [ æ”¿ç­–æœºé‡ ]
- åŒºåŸŸä¼˜åŠ¿: [ æ”¿ç­–æœºé‡ ]

### **äº”ã€è¿½èµ¶ç­–ç•¥å»ºè®®**

**5.1 æŠ€æœ¯çªç ´è·¯å¾„**
1. **çŸ­æœŸ** (1å¹´å†…): [ å…·ä½“ç­–ç•¥ ]
2. **ä¸­æœŸ** (2-3å¹´): [ å…·ä½“ç­–ç•¥ ]
3. **é•¿æœŸ** (5å¹´å†…): [ å…·ä½“ç­–ç•¥ ]

**5.2 å¸‚åœºçªç ´ç­–ç•¥**
- **å›½å†…å¸‚åœº**: [ ç­–ç•¥å»ºè®® ]
- **æµ·å¤–æ‹“å±•**: [ ç­–ç•¥å»ºè®® ]
- **ç»†åˆ†é¢†åŸŸ**: [ ç­–ç•¥å»ºè®® ]

**5.3 ç”Ÿæ€å»ºè®¾æ–¹æ¡ˆ**
- **äº§ä¸šé“¾æ•´åˆ**: [ å»ºè®¾æ–¹æ¡ˆ ]
- **åˆ›æ–°å¹³å°**: [ å»ºè®¾æ–¹æ¡ˆ ]
- **äººæ‰åŸ¹å…»**: [ å»ºè®¾æ–¹æ¡ˆ ]

### **å…­ã€æŠ•èµ„æœºä¼šä¸é£é™©**

**6.1 æŠ•èµ„æœºä¼š**
- **æŠ€æœ¯æŠ•èµ„**: [ æœºä¼šåˆ†æ ]
- **äº§ä¸šæŠ•èµ„**: [ æœºä¼šåˆ†æ ]
- **å¹¶è´­æ•´åˆ**: [ æœºä¼šåˆ†æ ]

**6.2 é£é™©æç¤º**
- **æŠ€æœ¯é£é™©**: [ é£é™©åˆ†æ ]
- **å¸‚åœºé£é™©**: [ é£é™©åˆ†æ ]
- **æ”¿ç­–é£é™©**: [ é£é™©åˆ†æ ]

---

### **ç»“è®ºä¸å»ºè®®**

**æ ¸å¿ƒç»“è®º**: [ åŸºäºå¯¹æ ‡åˆ†æçš„æ ¸å¿ƒç»“è®º ]

**æˆ˜ç•¥å»ºè®®**:
1. **ä¼˜å…ˆå‘å±•**: [ é‡ç‚¹é¢†åŸŸ ]
2. **é‡ç‚¹çªç ´**: [ å…³é”®æŠ€æœ¯ ]
3. **åˆä½œå…±èµ¢**: [ åˆä½œæ–¹å‘ ]

---

**å…è´£å£°æ˜**: æœ¬æŠ¥å‘ŠåŸºäºå…¬å¼€ä¿¡æ¯æ•´ç†åˆ†æï¼Œè§‚ç‚¹ä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚

**æ•°æ®æ¥æº**: ${article.link}  
**ç ”ç©¶å›¢é˜Ÿ**: KUATOåˆ¶é€ ä¸šç ”ç©¶é™¢  
**æŠ¥å‘Šç¼–å·**: ${article.id?.substring(0, 8) || 'N/A'}`;
  }

  // åŸºç¡€ä¿¡æ¯æ•´ç†æ¨¡æ¿
  function generateBasicTemplate(article: any): string {
    const date = new Date(article.created_at).toLocaleDateString('zh-CN');
    
    let content = `# ${article.title}\n\n`;
    
    // æ·»åŠ å…ƒä¿¡æ¯
    content += `**æ¥æº**: ${article.rss_sources?.name || 'æœªçŸ¥'}\n`;
    content += `**å‘å¸ƒæ—¶é—´**: ${date}\n`;
    if (article.ai_score) {
      content += `**AIè¯„åˆ†**: ${article.ai_score}/100\n`;
    }
    if (article.ai_category) {
      content += `**åˆ†ç±»**: ${article.ai_category}\n`;
    }
    content += `**åŸæ–‡é“¾æ¥**: [æŸ¥çœ‹åŸæ–‡](${article.link})\n\n`;
    
    content += `---\n\n`;
    
    // æ·»åŠ AIæ‘˜è¦
    if (article.ai_summary) {
      content += `## AI æ‘˜è¦\n\n${article.ai_summary}\n\n`;
    }
    
    // æ·»åŠ æˆ˜ç•¥æ„ä¹‰åˆ†æ
    if (article.ai_strategic_implication) {
      content += `## æˆ˜ç•¥æ„ä¹‰\n\n${article.ai_strategic_implication}\n\n`;
    }
    
    // æ·»åŠ å®Œæ•´å†…å®¹ï¼ˆå¦‚æœæœ‰ï¼‰
    if (article.full_content) {
      content += `## å®Œæ•´å†…å®¹\n\n${article.full_content}\n\n`;
    }
    
    content += `---\n\n`;
    content += `*æ­¤å†…å®¹ç”±åˆ¶é€ ä¸šæƒ…æŠ¥ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼ŒåŸºäºæ–‡ç« : "${article.title}"*\n`;
    
    return content;
  }

  // å¾®ä¿¡å…¬ä¼—å·æ¨¡æ¿é…ç½®
  const WECHAT_TEMPLATES = {
    'template1': {
      name: 'KUATOåˆ¶é€ ä¸šæƒ…æŠ¥',
      headerImage: 'https://mmbiz.qpic.cn/mmbiz_gif/zs1lfia1tiaJ4DuZdRCIkpgCNTHKef8yXgib4mT253dp7icWkOoxVRmx6e67IEf7BCCJSKLOlefkxs6gbtHklZuxjw/640?wx_fmt=gif&from=appmsg',
      footerImages: [
        'https://mmbiz.qpic.cn/mmbiz_png/zs1lfia1tiaJ4DuZdRCIkpgCNTHKef8yXgjwLADrFZm9aibicOgqOibyuWpQ5BsYU4n8KVqvhibe0adwEFFU2qGtbL8Q/640?wx_fmt=png&from=appmsg&watermark=1',
        'https://mmbiz.qpic.cn/mmbiz_png/zs1lfia1tiaJ4DuZdRCIkpgCNTHKef8yXgibtyNJJT0BticIXcicn421AgT8qGy7a6nDm57LTWA4W8WHnScRaI7Q9kA/640?wx_fmt=png&from=appmsg&watermark=1'
      ],
      brandName: 'KUATOåˆ¶é€ ä¸šæƒ…æŠ¥ç³»ç»Ÿ',
      description: 'ä¸“æ³¨åˆ¶é€ ä¸šæƒ…æŠ¥åˆ†æ'
    }
    // æœªæ¥å¯ä»¥æ·»åŠ æ›´å¤šæ¨¡æ¿
    // 'template2': { ... }
  };

  // å¾®ä¿¡å…¬ä¼—å·æ¨¡æ¿1ç”Ÿæˆå‡½æ•°
  function generateWechatTemplate1(article: any): string {
    const date = new Date(article.created_at).toLocaleDateString('zh-CN');
    const template = WECHAT_TEMPLATES.template1;
    
    // ç›´æ¥ä½¿ç”¨æ¨¡æ¿é…ç½®çš„é¢˜å›¾
    const headerImageUrl = template.headerImage;
    
    return `<style>
/* å¾®ä¿¡å…¬ä¼—å·æ ·å¼ */
.rich_media_content {
  max-width: 677px;
  margin: 0 auto;
  padding: 20px;
  font-family: -apple-system-font, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei UI", "Microsoft YaHei", Arial, sans-serif;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
}

.rich_media_title {
  font-size: 24px;
  font-weight: bold;
  line-height: 1.4;
  margin-bottom: 20px;
  text-align: center;
  color: #000;
}

.rich_media_meta {
  text-align: center;
  font-size: 14px;
  color: #888;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 1px solid #eee;
}

.rich_media_para {
  margin-bottom: 20px;
  font-size: 16px;
  text-align: justify;
}

.rich_media_strong {
  font-weight: bold;
  color: #000;
}

.rich_media_quote {
  padding: 15px 20px;
  margin: 20px 0;
  background-color: #f7f7f7;
  border-left: 4px solid #07c160;
  font-style: italic;
}

.rich_media_section {
  margin: 30px 0;
}

.rich_media_section_title {
  font-size: 18px;
  font-weight: bold;
  margin: 25px 0 15px 0;
  color: #000;
}

.rich_media_highlight {
  background-color: #fff2cc;
  padding: 2px 4px;
  border-radius: 3px;
}

.rich_media_header_image {
  width: 100%;
  max-width: 677px;
  height: 300px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.rich_media_footer {
  margin-top: 40px;
  padding-top: 20px;
  border-top: 1px solid #eee;
  text-align: center;
  font-size: 12px;
  color: #999;
}

.rich_media_footer_images {
  margin-top: 30px;
  text-align: center;
}

.rich_media_footer_image {
  width: 100%;
  max-width: 677px;
  margin: 10px 0;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
</style>

<div class="rich_media_content">

<img src="${headerImageUrl}" alt="${article.title}" class="rich_media_header_image" />

<h1 class="rich_media_title">${article.title}</h1>

<div class="rich_media_meta">
<strong>${template.brandName}</strong> | ${date}<br>
æ¥æºï¼š${article.rss_sources?.name || 'æœªçŸ¥'} | AIè¯„åˆ†ï¼š${article.ai_score || 'N/A'}/100
</div>

<div class="rich_media_section">
<h2 class="rich_media_section_title">ğŸ“Š æ ¸å¿ƒè§‚ç‚¹</h2>
<div class="rich_media_para">
${article.ai_summary || ''}
</div>
</div>

${article.ai_strategic_implication ? `
<div class="rich_media_quote">
<strong>æˆ˜ç•¥ä»·å€¼ï¼š</strong>${article.ai_strategic_implication}
</div>
` : ''}

<div class="rich_media_section">
<h2 class="rich_media_section_title">ğŸ” æ·±åº¦è§£è¯»</h2>
<div class="rich_media_para">
${article.full_content || article.description || ''}
</div>
</div>

<div class="rich_media_section">
<h2 class="rich_media_section_title">ğŸ’¡ è¡Œä¸šæ´å¯Ÿ</h2>
<div class="rich_media_para">
è¿™ä¸€åŠ¨æ€å¯¹åˆ¶é€ ä¸šçš„å¯ç¤ºï¼š
</div>
<div class="rich_media_para">
â€¢ <span class="rich_media_strong">æŠ€æœ¯è¶‹åŠ¿</span>ï¼š[ è¯·è¡¥å……æŠ€æœ¯å‘å±•è¶‹åŠ¿åˆ†æ ]
</div>
<div class="rich_media_para">
â€¢ <span class="rich_media_strong">å¸‚åœºæœºä¼š</span>ï¼š[ è¯·è¡¥å……å¸‚åœºæœºä¼šåˆ†æ ]
</div>
<div class="rich_media_para">
â€¢ <span class="rich_media_strong">æŠ•èµ„æ–¹å‘</span>ï¼š[ è¯·è¡¥å……æŠ•èµ„å»ºè®® ]
</div>
</div>

<div class="rich_media_section">
<h2 class="rich_media_section_title">ğŸ¯ å…³é”®è¦ç‚¹</h2>
<div class="rich_media_para">
<span class="rich_media_highlight">æ ¸å¿ƒæŠ€æœ¯</span>ï¼š[ è¯·æç‚¼æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹ ]
</div>
<div class="rich_media_para">
<span class="rich_media_highlight">åº”ç”¨åœºæ™¯</span>ï¼š[ è¯·åˆ†æä¸»è¦åº”ç”¨åœºæ™¯ ]
</div>
<div class="rich_media_para">
<span class="rich_media_highlight">å‘å±•å‰æ™¯</span>ï¼š[ è¯·è¯„ä¼°å‘å±•å‰æ™¯ ]
</div>
</div>

<div class="rich_media_footer">
<p>ğŸ“– æ›´å¤šåˆ¶é€ ä¸šæƒ…æŠ¥ï¼Œå…³æ³¨ <strong>${template.brandName}</strong></p>
<p>ğŸ”— åŸæ–‡é“¾æ¥ï¼š<a href="${article.link}" target="_blank">ç‚¹å‡»æŸ¥çœ‹</a></p>
<p>âš¡ æœ¬æ–‡ç”±AIæ™ºèƒ½åˆ†æç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒ</p>
</div>

<!-- ç»“å°¾å›¾ç‰‡ -->
<div class="rich_media_footer_images">
<img src="${template.footerImages[0]}" alt="${template.name} å…³æ³¨äºŒç»´ç " class="rich_media_footer_image" />
<img src="${template.footerImages[1]}" alt="${template.name} æ¨å¹¿å›¾" class="rich_media_footer_image" />
</div>

</div>`;
  }

  // ä¸»ç”Ÿæˆå‡½æ•° - æ ¹æ®é€‰æ‹©çš„æ¨¡æ¿ç”Ÿæˆå†…å®¹
  function generateMarkdownContent(article: any): string {
    const template = getSelectedTemplate();
    
    switch (template) {
      case 'intelligence':
        return generateIntelligenceTemplate(article);
      case 'wechat-template1':
        return generateWechatTemplate1(article);
      case 'technology':
        return generateTechnologyTemplate(article);
      case 'market':
        return generateMarketTemplate(article);
      case 'benchmark':
        return generateBenchmarkTemplate(article);
      case 'basic':
      default:
        return generateBasicTemplate(article);
    }
  }

  // æ’å…¥å†…å®¹åˆ° Doocs MD ç¼–è¾‘å™¨çš„å‡½æ•°
  function insertContentToEditor(content: string): boolean {
    const doocsIframe = document.getElementById('doocs-editor') as HTMLIFrameElement;
    
    if (!doocsIframe) {
      console.error('Doocs MD ç¼–è¾‘å™¨æœªæ‰¾åˆ°');
      return false;
    }
    
    try {
      // é€šè¿‡ postMessage å‘é€å†…å®¹åˆ° Doocs MD
      const message = {
        type: 'INSERT_CONTENT',
        content: content,
        timestamp: Date.now()
      };
      
      console.log('æ­£åœ¨å‘ Doocs MD å‘é€å†…å®¹...', content.length, 'å­—ç¬¦');
      doocsIframe.contentWindow?.postMessage(message, 'https://md.doocs.org');
      
      // åŒæ—¶å¤åˆ¶åˆ°å‰ªè´´æ¿ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
      navigator.clipboard.writeText(content).then(() => {
        console.log('âœ… å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
      }).catch(err => {
        console.log('å‰ªè´´æ¿å¤åˆ¶å¤±è´¥:', err);
      });
      
      // æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
      showNotification('å†…å®¹å·²å‘é€åˆ°ç¼–è¾‘å™¨å¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¦‚éœ€è¦è¯·åœ¨ç¼–è¾‘å™¨ä¸­ç²˜è´´ï¼ˆCtrl+Vï¼‰', 'success');
      
      return true;
      
    } catch (error) {
      console.error('æ’å…¥å†…å®¹åˆ° Doocs MD å¤±è´¥:', error);
      return false;
    }
  }
  

  document.addEventListener('DOMContentLoaded', function() {
    console.log('=== ç¼–è¾‘å°é¡µé¢åˆå§‹åŒ– ===');
    
    // æ£€æŸ¥ Doocs MD ç¼–è¾‘å™¨
    const doocsIframe = document.getElementById('doocs-editor') as HTMLIFrameElement;
    const editorStatus = document.getElementById('editor-status');
    
    console.log('Doocs MD ç¼–è¾‘å™¨:', !!doocsIframe);
    
    // åˆ·æ–°ç¼–è¾‘å™¨æŒ‰é’®
    document.getElementById('refresh-editor')?.addEventListener('click', function() {
      if (doocsIframe) {
        doocsIframe.src = doocsIframe.src; // é‡æ–°åŠ è½½ iframe
        if (editorStatus) {
          editorStatus.innerHTML = `
            <svg class="w-4 h-4 mr-1 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            ç¼–è¾‘å™¨é‡æ–°åŠ è½½ä¸­...
          `;
        }
      }
    });

    // æ¨¡æ¿é¢„è§ˆæŒ‰é’®
    document.getElementById('preview-template')?.addEventListener('click', function() {
      const template = getSelectedTemplate();
      
      // åˆ›å»ºæ¨¡æ‹Ÿæ–‡ç« æ•°æ®ç”¨äºé¢„è§ˆ
      const mockArticle = {
        title: "ç¤ºä¾‹æ–‡ç« æ ‡é¢˜ - æ™ºèƒ½åˆ¶é€ æŠ€æœ¯çªç ´",
        ai_summary: "è¿™æ˜¯ä¸€ä¸ªAIç”Ÿæˆçš„æ‘˜è¦ç¤ºä¾‹ï¼Œå±•ç¤ºäº†æ–‡ç« çš„æ ¸å¿ƒå†…å®¹å’Œä¸»è¦è§‚ç‚¹ã€‚",
        ai_strategic_implication: "è¿™é¡¹æŠ€æœ¯å¯¹åˆ¶é€ ä¸šå…·æœ‰é‡è¦çš„æˆ˜ç•¥æ„ä¹‰ï¼Œå¯èƒ½æ”¹å˜è¡Œä¸šæ ¼å±€ã€‚",
        ai_category: "Core Equipment",
        ai_score: 85,
        created_at: new Date().toISOString(),
        link: "https://example.com/article",
        full_content: "è¿™é‡Œæ˜¯æ–‡ç« çš„å®Œæ•´å†…å®¹ç¤ºä¾‹...",
        description: "æ–‡ç« æè¿°ç¤ºä¾‹",
        id: "preview-123",
        rss_sources: { name: "ç¤ºä¾‹æ¥æº" }
      };
      
      // ç”Ÿæˆé¢„è§ˆå†…å®¹
      const previewContent = generateMarkdownContent(mockArticle);
      
      // æ’å…¥é¢„è§ˆå†…å®¹åˆ°ç¼–è¾‘å™¨
      const success = insertContentToEditor(previewContent);
      
      if (success) {
        showNotification('âœ… æ¨¡æ¿é¢„è§ˆå·²åŠ è½½åˆ°ç¼–è¾‘å™¨', 'success');
      } else {
        showNotification('âŒ é¢„è§ˆåŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
      }
    });

    // æ¨¡æ¿é€‰æ‹©å™¨å˜åŒ–äº‹ä»¶ - æ˜¾ç¤ºæ¨¡æ¿ä¿¡æ¯
    document.getElementById('template-selector')?.addEventListener('change', function(e) {
      const selectedTemplate = (e.target as HTMLSelectElement).value;
      const templateInfo = document.getElementById('template-info');
      const templateInfoContent = document.getElementById('template-info-content');
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯å¾®ä¿¡å…¬ä¼—å·æ¨¡æ¿
      if (selectedTemplate.startsWith('wechat-')) {
        templateInfo!.style.display = 'block';
        
        // æ˜¾ç¤ºæ¨¡æ¿ä¿¡æ¯
        if (selectedTemplate === 'wechat-template1') {
          const template = WECHAT_TEMPLATES.template1;
          templateInfoContent!.innerHTML = `
            ğŸ“± <strong>${template.name}</strong> | ${template.description}<br>
            ğŸ“¸ åŒ…å«ï¼šå›ºå®šé¢˜å›¾ + å†…å®¹ç»“æ„ + ç»“å°¾ä¸¤å¼ å›¾ç‰‡ | ğŸ¨ å¾®ä¿¡å…¬ä¼—å·æ ‡å‡†æ ·å¼
          `;
        }
      } else {
        templateInfo!.style.display = 'none';
      }
    });

    
    // iframe åŠ è½½å®Œæˆäº‹ä»¶
    doocsIframe?.addEventListener('load', function() {
      console.log('âœ… Doocs MD ç¼–è¾‘å™¨åŠ è½½å®Œæˆ');
      if (editorStatus) {
        editorStatus.innerHTML = `
          <svg class="w-4 h-4 mr-1 text-green-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
          <span class="text-green-600">ç¼–è¾‘å™¨å°±ç»ª</span>
        `;
      }
    });
    
    // ç›‘å¬æ¥è‡ª Doocs MD çš„æ¶ˆæ¯
    window.addEventListener('message', function(event) {
      // ç¡®ä¿æ¶ˆæ¯æ¥è‡ª Doocs MD
      if (event.origin !== 'https://md.doocs.org') {
        return;
      }
      
      console.log('æ”¶åˆ°æ¥è‡ª Doocs MD çš„æ¶ˆæ¯:', event.data);
      
      // å¤„ç†ç¼–è¾‘å™¨çš„å“åº”
      if (event.data.type === 'CONTENT_RECEIVED') {
        showNotification('âœ… å†…å®¹å·²æˆåŠŸæ’å…¥åˆ° Doocs MD ç¼–è¾‘å™¨', 'success');
      } else if (event.data.type === 'EDITOR_READY') {
        console.log('Doocs MD ç¼–è¾‘å™¨å·²å‡†å¤‡å¥½æ¥æ”¶å†…å®¹');
        if (editorStatus) {
          editorStatus.innerHTML = `
            <svg class="w-4 h-4 mr-1 text-green-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            <span class="text-green-600">ç¼–è¾‘å™¨å°±ç»ª</span>
          `;
        }
      }
    });
    
    // ä½¿ç”¨æ–‡ç« æŒ‰é’®
    const useArticleBtns = document.querySelectorAll('.use-article');
    console.log('æ‰¾åˆ°ä½¿ç”¨æ–‡ç« æŒ‰é’®æ•°é‡:', useArticleBtns.length);
    
    useArticleBtns.forEach((btn, index) => {
      console.log(`ç»‘å®šç¬¬ ${index + 1} ä¸ªæŒ‰é’®äº‹ä»¶ç›‘å¬å™¨`);
      
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('=== ä½¿ç”¨æ–‡ç« æŒ‰é’®è¢«ç‚¹å‡» ===');
        
        const articleId = (this as HTMLElement).dataset.id;
        console.log('æ–‡ç«  ID:', articleId);
        
        // è·å–æ–‡ç« å†…å®¹å¹¶æ’å…¥åˆ°ç¼–è¾‘å™¨
        console.log('æ­£åœ¨è·å–æ–‡ç« è¯¦æƒ…...');
        
        fetch(`/api/articles/${articleId}`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTPé”™è¯¯: ${response.status}`);
            }
            return response.json();
          })
          .then(result => {
            if (!result.success) {
              throw new Error(result.error || 'è·å–æ–‡ç« å¤±è´¥');
            }
            
            const article = result.data;
            console.log('âœ… è·å–æ–‡ç« æˆåŠŸ:', article.title);
            
            // å‡†å¤‡è¦æ’å…¥ç¼–è¾‘å™¨çš„å†…å®¹
            const content = generateMarkdownContent(article);
            
            console.log('å‡†å¤‡æ’å…¥å†…å®¹åˆ°ç¼–è¾‘å™¨...');
            
            // ç›´æ¥æ’å…¥å†…å®¹åˆ°ç¼–è¾‘å™¨
            const success = insertContentToEditor(content);
            
            if (success) {
              console.log('âœ… å†…å®¹å·²å‘é€åˆ° Doocs MD ç¼–è¾‘å™¨');
            } else {
              showNotification('âŒ æ’å…¥å†…å®¹å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            }
            
            // åœ¨æ§åˆ¶å°æ˜¾ç¤ºå†…å®¹ä¾›è°ƒè¯•
            console.log('=== ç”Ÿæˆçš„Markdownå†…å®¹ ===');
            console.log(content);
            console.log('=== å†…å®¹ç»“æŸ ===');
            
          })
          .catch(error => {
            console.error('âŒ è·å–æ–‡ç« å¤±è´¥:', error);
            showNotification(`è·å–æ–‡ç« å†…å®¹å¤±è´¥: ${error.message}`, 'error');
          });
      });
    });
    
    // æŸ¥çœ‹åŸæ–‡æŒ‰é’®
    document.querySelectorAll('.view-original').forEach(btn => {
      btn.addEventListener('click', function() {
        const url = (this as HTMLElement).dataset.url;
        if (url) {
          window.open(url, '_blank');
        }
      });
    });
  });

  // ç®€å•çš„é€šçŸ¥å‡½æ•°æ›¿ä»£UIKit
  function showNotification(message: string, type: 'success' | 'error' | 'warning' = 'success') {
    const notification = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 
                   type === 'error' ? 'bg-red-100 border-red-400 text-red-700' : 
                   'bg-yellow-100 border-yellow-400 text-yellow-700';
    
    notification.className = `fixed top-4 right-4 border px-4 py-3 rounded-lg shadow-lg z-50 max-w-sm ${bgColor}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 5000);
  }
</script>

<style>
  /* Text truncation utility */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Animation utilities for better UX */
  .fade-in {
    animation: fadeIn 0.3s ease-in-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Custom scrollbar for article list */
  .overflow-y-auto::-webkit-scrollbar {
    width: 6px;
  }
  
  .overflow-y-auto::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
  }
  
  .overflow-y-auto::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
  }
  
  .overflow-y-auto::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
</style>