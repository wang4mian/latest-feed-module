---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import { getArticles } from '../lib/supabase';

// 临时：获取所有文章来调试
const { data: allArticles, error: allError } = await getArticles({
  limit: 50,
  sort: 'ai_score_desc'
});

// 获取用户已采用的文章（通过文章池点击"采用"按钮的文章）
const { data: adoptedArticles, error } = await getArticles({
  status: 'adopted',
  limit: 50,
  sort: 'ai_score_desc'
});

// 调试信息
console.log('编辑台 - 所有文章:', {
  count: allArticles?.length || 0,
  error: allError,
  statuses: allArticles?.map(a => a.overall_status) || []
});

console.log('编辑台 - 已通过文章查询结果:', {
  count: adoptedArticles?.length || 0,
  error: error,
  articles: adoptedArticles
});

// 格式化日期
const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString('zh-CN', {
    month: 'short', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
};

// 获取分类显示文本
const getCategoryText = (category: string) => {
  const categoryMap: { [key: string]: string } = {
    'Core Equipment': '核心设备',
    'Supply Chain': '供应链', 
    'Market Trends': '市场趋势',
    'Technological Innovation': '技术创新',
    'Business Models': '商业模式'
  };
  return categoryMap[category] || category || '未分类';
};

// 获取评分颜色类 (现在使用 Tailwind)
const getScoreColor = (score: number) => {
  if (score >= 80) return 'text-green-600';
  if (score >= 60) return 'text-yellow-600';
  return 'text-gray-500';
};
---

<DashboardLayout title="编辑台 - KUATO">
  <!-- Page Header -->
  <div class="mb-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">编辑工作台</h1>
        <p class="mt-1 text-sm text-gray-500">
          KUATO AI智能内容创作平台 - 基于AI筛选文章创作深度情报内容
        </p>
      </div>
      <div class="flex items-center space-x-3">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
          {adoptedArticles?.length || 0} 篇已通过
        </span>
      </div>
    </div>
  </div>

  <!-- Two Column Layout -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-12rem)]">
    
    <!-- Left Column: Article List -->
    <div class="lg:col-span-1 bg-gray-50 rounded-lg border border-gray-200 flex flex-col">
      <div class="p-4 border-b border-gray-200">
        <!-- Header -->
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-medium text-gray-900">已通过文章</h3>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
            {adoptedArticles?.length || 0}
          </span>
        </div>
        
        <!-- Search Box -->
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          <input 
            type="search" 
            placeholder="搜索文章标题..."
            class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm"
          />
        </div>
      </div>
      
      <!-- Article List -->
      <div class="flex-1 overflow-y-auto p-4 space-y-3">
        {adoptedArticles && adoptedArticles.length > 0 ? (
          adoptedArticles.map((article: any) => (
            <div class="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow cursor-pointer" 
                 data-article-id={article.id}>
              <!-- Score and Date -->
              <div class="flex items-center justify-between mb-2">
                <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold ${
                  (article.ai_score || 0) >= 80 ? 'bg-green-100 text-green-800' : 
                  (article.ai_score || 0) >= 60 ? 'bg-yellow-100 text-yellow-800' : 
                  'bg-gray-100 text-gray-800'
                }`}>
                  {article.ai_score || 0}
                </span>
                <span class="text-xs text-gray-500">
                  {formatDate(article.created_at)}
                </span>
              </div>
              
              <!-- Title -->
              <h4 class="text-sm font-medium text-gray-900 line-clamp-2 mb-2">
                {article.title}
              </h4>
              
              <!-- Meta Info -->
              <div class="flex items-center text-xs text-gray-500 mb-3 space-x-2">
                <span>{article.rss_sources?.name || '未知来源'}</span>
                {article.ai_category && (
                  <>
                    <span>•</span>
                    <span>{getCategoryText(article.ai_category)}</span>
                  </>
                )}
              </div>
              
              <!-- Actions -->
              <div class="flex space-x-2">
                <button class="inline-flex items-center px-3 py-1 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 use-article" 
                        data-id={article.id}>
                  <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                  </svg>
                  使用文章
                </button>
                <button class="inline-flex items-center px-3 py-1 text-xs font-medium text-gray-700 bg-gray-100 rounded hover:bg-gray-200 view-original" 
                        data-url={article.link}>
                  <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                  </svg>
                  查看原文
                </button>
              </div>
            </div>
          ))
        ) : (
          <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p class="mt-4 text-sm text-gray-500">暂无已通过的文章</p>
            <p class="text-xs text-gray-400">请先到文章池筛选通过一些文章</p>
          </div>
        )}
      </div>
    </div>

    <!-- Right Column: Doocs MD Editor -->
    <div class="lg:col-span-2 bg-white rounded-lg border border-gray-200 flex flex-col">
      
      <!-- Editor Header -->
      <div class="p-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <div class="flex items-center text-gray-700">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            <span class="font-medium">Doocs MD 编辑器</span>
          </div>
          <div class="flex items-center space-x-2">
            <button class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" id="refresh-editor">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              刷新编辑器
            </button>
            <a class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" href="https://md.doocs.org/" target="_blank">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
              新窗口打开
            </a>
          </div>
        </div>
      </div>
      
      <!-- Doocs MD iframe Editor -->
      <div class="flex-1 relative">
        <iframe 
          id="doocs-editor"
          src="https://md.doocs.org/"
          class="w-full h-full"
          style="border: none; background: white;"
          sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"
        ></iframe>
      </div>
      
      <!-- Editor Footer -->
      <div class="p-3 bg-gray-50 border-t border-gray-200 text-sm">
        <div class="flex items-center justify-between">
          <div class="flex items-center text-gray-600">
            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
            <span>Doocs MD 开源编辑器 - 支持实时预览、主题切换、数学公式、微信公众号样式</span>
          </div>
          <div id="editor-status" class="flex items-center text-gray-500">
            <svg class="w-4 h-4 mr-1 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            编辑器加载中...
          </div>
        </div>
      </div>
      
    </div>
    
  </div>

</DashboardLayout>

<script>
  // 生成 Markdown 内容的函数
  function generateMarkdownContent(article: any) {
    const date = new Date(article.created_at).toLocaleDateString('zh-CN');
    
    let content = `# ${article.title}\n\n`;
    
    // 添加元信息
    content += `**来源**: ${article.rss_sources?.name || '未知'}\n`;
    content += `**发布时间**: ${date}\n`;
    if (article.ai_score) {
      content += `**AI评分**: ${article.ai_score}/100\n`;
    }
    if (article.ai_category) {
      content += `**分类**: ${article.ai_category}\n`;
    }
    content += `**原文链接**: [查看原文](${article.link})\n\n`;
    
    content += `---\n\n`;
    
    // 添加AI摘要
    if (article.ai_summary) {
      content += `## AI 摘要\n\n${article.ai_summary}\n\n`;
    }
    
    // 添加战略意义分析
    if (article.ai_strategic_implication) {
      content += `## 战略意义\n\n${article.ai_strategic_implication}\n\n`;
    }
    
    // 添加原始描述
    if (article.description) {
      content += `## 原始摘要\n\n${article.description}\n\n`;
    }
    
    // 添加完整内容（如果有）
    if (article.full_content) {
      content += `## 完整内容\n\n${article.full_content}\n\n`;
    }
    
    content += `---\n\n`;
    content += `*此内容由制造业情报系统自动生成，基于文章: "${article.title}"*\n`;
    
    return content;
  }

  // 插入内容到 Doocs MD 编辑器的函数
  function insertContentToEditor(content: string): boolean {
    const doocsIframe = document.getElementById('doocs-editor') as HTMLIFrameElement;
    
    if (!doocsIframe) {
      console.error('Doocs MD 编辑器未找到');
      return false;
    }
    
    try {
      // 通过 postMessage 发送内容到 Doocs MD
      const message = {
        type: 'INSERT_CONTENT',
        content: content,
        timestamp: Date.now()
      };
      
      console.log('正在向 Doocs MD 发送内容...', content.length, '字符');
      doocsIframe.contentWindow?.postMessage(message, 'https://md.doocs.org');
      
      // 同时复制到剪贴板作为备选方案
      navigator.clipboard.writeText(content).then(() => {
        console.log('✅ 内容已复制到剪贴板');
      }).catch(err => {
        console.log('剪贴板复制失败:', err);
      });
      
      // 显示使用说明
      showNotification('内容已发送到编辑器并复制到剪贴板，如需要请在编辑器中粘贴（Ctrl+V）', 'success');
      
      return true;
      
    } catch (error) {
      console.error('插入内容到 Doocs MD 失败:', error);
      return false;
    }
  }
  

  document.addEventListener('DOMContentLoaded', function() {
    console.log('=== 编辑台页面初始化 ===');
    
    // 检查 Doocs MD 编辑器
    const doocsIframe = document.getElementById('doocs-editor') as HTMLIFrameElement;
    const editorStatus = document.getElementById('editor-status');
    
    console.log('Doocs MD 编辑器:', !!doocsIframe);
    
    // 刷新编辑器按钮
    document.getElementById('refresh-editor')?.addEventListener('click', function() {
      if (doocsIframe) {
        doocsIframe.src = doocsIframe.src; // 重新加载 iframe
        if (editorStatus) {
          editorStatus.innerHTML = `
            <svg class="w-4 h-4 mr-1 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            编辑器重新加载中...
          `;
        }
      }
    });
    
    // iframe 加载完成事件
    doocsIframe?.addEventListener('load', function() {
      console.log('✅ Doocs MD 编辑器加载完成');
      if (editorStatus) {
        editorStatus.innerHTML = `
          <svg class="w-4 h-4 mr-1 text-green-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
          <span class="text-green-600">编辑器就绪</span>
        `;
      }
    });
    
    // 监听来自 Doocs MD 的消息
    window.addEventListener('message', function(event) {
      // 确保消息来自 Doocs MD
      if (event.origin !== 'https://md.doocs.org') {
        return;
      }
      
      console.log('收到来自 Doocs MD 的消息:', event.data);
      
      // 处理编辑器的响应
      if (event.data.type === 'CONTENT_RECEIVED') {
        showNotification('✅ 内容已成功插入到 Doocs MD 编辑器', 'success');
      } else if (event.data.type === 'EDITOR_READY') {
        console.log('Doocs MD 编辑器已准备好接收内容');
        if (editorStatus) {
          editorStatus.innerHTML = `
            <svg class="w-4 h-4 mr-1 text-green-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            <span class="text-green-600">编辑器就绪</span>
          `;
        }
      }
    });
    
    // 使用文章按钮
    const useArticleBtns = document.querySelectorAll('.use-article');
    console.log('找到使用文章按钮数量:', useArticleBtns.length);
    
    useArticleBtns.forEach((btn, index) => {
      console.log(`绑定第 ${index + 1} 个按钮事件监听器`);
      
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('=== 使用文章按钮被点击 ===');
        
        const articleId = (this as HTMLElement).dataset.id;
        console.log('文章 ID:', articleId);
        
        // 获取文章内容并插入到编辑器
        console.log('正在获取文章详情...');
        
        fetch(`/api/articles/${articleId}`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP错误: ${response.status}`);
            }
            return response.json();
          })
          .then(result => {
            if (!result.success) {
              throw new Error(result.error || '获取文章失败');
            }
            
            const article = result.data;
            console.log('✅ 获取文章成功:', article.title);
            
            // 准备要插入编辑器的内容
            const content = generateMarkdownContent(article);
            
            console.log('准备插入内容到编辑器...');
            
            // 直接插入内容到编辑器
            const success = insertContentToEditor(content);
            
            if (success) {
              console.log('✅ 内容已发送到 Doocs MD 编辑器');
            } else {
              showNotification('❌ 插入内容失败，请刷新页面重试', 'error');
            }
            
            // 在控制台显示内容供调试
            console.log('=== 生成的Markdown内容 ===');
            console.log(content);
            console.log('=== 内容结束 ===');
            
          })
          .catch(error => {
            console.error('❌ 获取文章失败:', error);
            showNotification(`获取文章内容失败: ${error.message}`, 'error');
          });
      });
    });
    
    // 查看原文按钮
    document.querySelectorAll('.view-original').forEach(btn => {
      btn.addEventListener('click', function() {
        const url = (this as HTMLElement).dataset.url;
        if (url) {
          window.open(url, '_blank');
        }
      });
    });
  });

  // 简单的通知函数替代UIKit
  function showNotification(message: string, type: 'success' | 'error' | 'warning' = 'success') {
    const notification = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 
                   type === 'error' ? 'bg-red-100 border-red-400 text-red-700' : 
                   'bg-yellow-100 border-yellow-400 text-yellow-700';
    
    notification.className = `fixed top-4 right-4 border px-4 py-3 rounded-lg shadow-lg z-50 max-w-sm ${bgColor}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 5000);
  }
</script>

<style>
  /* Text truncation utility */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Animation utilities for better UX */
  .fade-in {
    animation: fadeIn 0.3s ease-in-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Custom scrollbar for article list */
  .overflow-y-auto::-webkit-scrollbar {
    width: 6px;
  }
  
  .overflow-y-auto::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
  }
  
  .overflow-y-auto::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
  }
  
  .overflow-y-auto::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
</style>