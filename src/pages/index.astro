---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import { getArticleStats } from '../lib/supabase';

// 获取统计数据，使用 try-catch 处理可能的错误
let statusStats = [];
let categoryStats = [];
let recentCount = 0;

try {
  const stats = await getArticleStats();
  statusStats = stats.statusStats;
  categoryStats = stats.categoryStats;
  recentCount = stats.recentCount;
} catch (error) {
  console.error('Failed to load article stats:', error);
  // 使用默认值继续渲染页面
}

// 处理状态统计
const statusCounts = statusStats.reduce((acc: Record<string, number>, item: any) => {
  acc[item.overall_status] = (acc[item.overall_status] || 0) + 1;
  return acc;
}, {});

// 处理分类统计
const categoryCounts = categoryStats.reduce((acc: Record<string, number>, item: any) => {
  acc[item.ai_category] = (acc[item.ai_category] || 0) + 1;
  return acc;
}, {});

const totalArticles = statusStats.length;
const analyzedArticles = statusStats.filter((item: any) => 
  ['ready_for_review', 'reviewed', 'published', 'adopted', 'archived'].includes(item.overall_status)
).length;
---

<DashboardLayout title="Overview - KUATO">
  <!-- Page Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Overview</h1>
    <p class="mt-2 text-gray-600">KUATO AI智能情报系统 - 实时监控系统运行状态和数据处理进度</p>
  </div>

  <!-- Key Metrics -->
  <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4 mb-8">
    <!-- Total Articles -->
    <div class="dashboard-card">
      <div class="dashboard-card-body">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-blue-100 rounded-md flex items-center justify-center">
              <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </div>
          </div>
          <div class="ml-4">
            <p class="text-2xl font-semibold text-gray-900">{totalArticles}</p>
            <p class="text-sm text-gray-500">总文章数</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Analyzed Articles -->
    <div class="dashboard-card">
      <div class="dashboard-card-body">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-green-100 rounded-md flex items-center justify-center">
              <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
          <div class="ml-4">
            <p class="text-2xl font-semibold text-gray-900">{analyzedArticles}</p>
            <p class="text-sm text-gray-500">已分析</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Today's Articles -->
    <div class="dashboard-card">
      <div class="dashboard-card-body">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-yellow-100 rounded-md flex items-center justify-center">
              <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
            </div>
          </div>
          <div class="ml-4">
            <p class="text-2xl font-semibold text-gray-900">{recentCount}</p>
            <p class="text-sm text-gray-500">今日新增</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Coverage Rate -->
    <div class="dashboard-card">
      <div class="dashboard-card-body">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-purple-100 rounded-md flex items-center justify-center">
              <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
            </div>
          </div>
          <div class="ml-4">
            <p class="text-2xl font-semibold text-gray-900">
              {totalArticles > 0 ? Math.round((analyzedArticles / totalArticles) * 100) : 0}%
            </p>
            <p class="text-sm text-gray-500">分析覆盖率</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Status Distribution -->
    <div class="dashboard-card">
      <div class="dashboard-card-header">
        <h3 class="text-lg font-medium text-gray-900">文章状态分布</h3>
        <p class="text-sm text-gray-500">实时显示文章处理状态</p>
      </div>
      <div class="dashboard-card-body">
        <div class="space-y-4">
          {Object.entries(statusCounts).map(([status, count]) => {
            const percentage = totalArticles > 0 ? (count / totalArticles * 100).toFixed(1) : '0';
            let statusText = '';
            let statusClass = '';
            
            switch(status) {
              case 'ready_for_review': statusText = '待审核'; statusClass = 'high'; break;
              case 'reviewed': statusText = '已审核'; statusClass = 'medium'; break;
              case 'draft': statusText = '待分析'; statusClass = 'low'; break;
              default: statusText = status; statusClass = 'low';
            }
            
            return (
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <span class={`status-badge ${statusClass}`}>{statusText}</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span class="text-sm font-medium text-gray-900">{count}</span>
                  <span class="text-sm text-gray-500">({percentage}%)</span>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </div>

    <!-- Category Distribution -->
    <div class="dashboard-card">
      <div class="dashboard-card-header">
        <h3 class="text-lg font-medium text-gray-900">内容分类分布</h3>
        <p class="text-sm text-gray-500">AI智能分类统计</p>
      </div>
      <div class="dashboard-card-body">
        <div class="space-y-4">
          {Object.entries(categoryCounts).slice(0, 5).map(([category, count]) => {
            const percentage = analyzedArticles > 0 ? (count / analyzedArticles * 100).toFixed(1) : '0';
            let categoryText = '';
            let categoryClass = '';
            
            switch(category) {
              case 'Core Equipment': categoryText = '核心设备'; categoryClass = 'equipment'; break;
              case 'Supply Chain': categoryText = '供应链'; categoryClass = 'supply'; break;
              case 'Market Trends': categoryText = '市场趋势'; categoryClass = 'trends'; break;
              case 'Technological Innovation': categoryText = '技术创新'; categoryClass = 'innovation'; break;
              case 'Business Models': categoryText = '商业模式'; categoryClass = 'business'; break;
              default: categoryText = category; categoryClass = 'equipment';
            }
            
            return (
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <span class={`category-tag ${categoryClass}`}>{categoryText}</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span class="text-sm font-medium text-gray-900">{count}</span>
                  <span class="text-sm text-gray-500">({percentage}%)</span>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="mt-8">
    <div class="dashboard-card">
      <div class="dashboard-card-header">
        <h3 class="text-lg font-medium text-gray-900">快速操作</h3>
        <p class="text-sm text-gray-500">常用功能快速入口</p>
      </div>
      <div class="dashboard-card-body">
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
          <a href="/pool" class="flex items-center p-4 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">
            <div class="flex-shrink-0">
              <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9.5a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-blue-900">文章池</p>
              <p class="text-xs text-blue-700">筛选和管理文章</p>
            </div>
          </a>

          <a href="/editor" class="flex items-center p-4 bg-green-50 rounded-lg hover:bg-green-100 transition-colors">
            <div class="flex-shrink-0">
              <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-green-900">编辑工作台</p>
              <p class="text-xs text-green-700">创作深度文章</p>
            </div>
          </a>

          <a href="/sources" class="flex items-center p-4 bg-yellow-50 rounded-lg hover:bg-yellow-100 transition-colors">
            <div class="flex-shrink-0">
              <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-yellow-900">RSS源管理</p>
              <p class="text-xs text-yellow-700">配置数据源</p>
            </div>
          </a>

          <a href="/health" class="flex items-center p-4 bg-purple-50 rounded-lg hover:bg-purple-100 transition-colors">
            <div class="flex-shrink-0">
              <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-purple-900">系统健康</p>
              <p class="text-xs text-purple-700">监控系统状态</p>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>

</DashboardLayout>